# Python客户端违规上报接口更新说明

## 📋 更新概述

本次更新将Python客户端的违规上报机制从分离式接口改为统一的 `report-with-screenshot` 接口，实现违规事件和截图的一次性上报。

## 🔄 主要变更

### 1. 接口变更

#### 更新前
- **接口**: `POST /api/security/violations/report`
- **格式**: `application/json`
- **功能**: 仅上报违规事件数据

#### 更新后
- **接口**: `POST /api/security/violations/report-with-screenshot`
- **格式**: `multipart/form-data`
- **功能**: 同时上报违规事件和截图

### 2. 数据格式变更

#### 更新前 (JSON格式)
```json
{
  "clientId": "uuid",
  "violationType": "BLOCKCHAIN_ADDRESS",
  "violationContent": "address",
  "additionalData": {...}
}
```

#### 更新后 (Form-data格式)
```
clientId: uuid
violationType: BLOCKCHAIN_ADDRESS
violationContent: address
timestamp: 2025-08-22T12:00:00.000Z
additionalData: {"key": "value"}
file: screenshot.jpg
```

## 🔧 代码变更详情

### 1. ViolationReporter 模块更新

**文件**: `src/modules/violation.py`

#### 主要变更
- `_send_violation_report()` 方法重构
- 新增 `_prepare_violation_data()` 方法
- 新增 `_get_current_screenshot()` 方法

#### 核心功能
```python
def _prepare_violation_data(self, violation_data: Dict) -> tuple:
    """准备违规数据为新接口格式"""
    # 转换为form-data格式
    form_data = {
        'clientId': violation_data.get('clientId'),
        'violationType': violation_data.get('violationType'),
        'violationContent': violation_data.get('violationContent'),
        'timestamp': violation_data.get('report_time'),
        'additionalData': json.dumps(additional_data)
    }
    
    # 获取截图
    files_data = {'file': (filename, screenshot_data, 'image/jpeg')}
    
    return files_data, form_data
```

### 2. BlockchainAddressDetector 模块更新

**文件**: `src/modules/blockchain_detector.py`

#### 主要变更
- 统一违规数据格式
- 增强附加数据内容
- 添加检测方法标识

#### 数据格式增强
```python
enhanced_violation_data = {
    'clientId': client_id,
    'violationType': 'BLOCKCHAIN_ADDRESS',
    'violationContent': address,
    'report_time': datetime.now().isoformat(),
    'additionalData': {
        'address_type': address_type,
        'fullClipboardContent': content[:500],
        'detected_at': datetime.now().isoformat(),
        'detection_method': 'clipboard_monitor',
        'risk_level': 'HIGH'
    }
}
```

## 🎯 新功能特性

### 1. 自动截图获取
- 违规事件发生时自动获取当前屏幕截图
- 支持JPEG格式压缩
- 失败时使用占位文件

### 2. 增强的附加数据
- **检测方法**: 标识违规检测的具体方式
- **风险级别**: 标识违规事件的风险等级
- **时间戳**: 精确的检测时间
- **客户端信息**: 版本和平台信息

### 3. 改进的错误处理
- 更详细的响应解析
- 支持新接口的响应格式
- 更好的重试机制

## 🧪 测试验证

### 测试脚本
运行 `test_violation_update.py` 进行功能验证：

```bash
cd clients/python
python test_violation_update.py
```

### 测试内容
1. **数据格式转换测试**: 验证新旧格式的转换
2. **违规上报器测试**: 测试单独的违规事件上报
3. **区块链检测器测试**: 测试完整的检测和上报流程

## 📊 兼容性说明

### 向后兼容
- 保持原有的违规检测逻辑不变
- 保持原有的配置文件格式
- 保持原有的API调用方式

### 依赖要求
- **PIL (Pillow)**: 用于截图功能
- **requests**: HTTP请求库
- **json**: JSON数据处理

### 平台支持
- **Windows**: 完全支持，包括截图功能
- **macOS**: 支持截图功能
- **Linux**: 基础功能支持，截图功能有限

## ⚠️ 注意事项

### 1. 截图功能
- 在无图形界面的Linux服务器上，截图功能会使用占位文件
- 确保客户端有足够的权限访问屏幕

### 2. 网络要求
- 新接口需要上传文件，网络带宽要求更高
- 建议设置合适的超时时间

### 3. 存储空间
- 每次违规上报都会包含截图，注意本地存储空间

## 🔍 故障排查

### 常见问题

#### 1. 截图获取失败
**症状**: 日志显示"无法获取截图"
**解决**: 
- 检查PIL库是否正确安装
- 确认运行环境支持图形界面
- 检查屏幕访问权限

#### 2. 接口调用失败
**症状**: HTTP错误或超时
**解决**:
- 检查服务器地址配置
- 验证网络连接
- 检查服务器端接口状态

#### 3. 数据格式错误
**症状**: 服务器返回400错误
**解决**:
- 检查必填字段是否完整
- 验证时间戳格式
- 检查JSON数据格式

### 调试方法
1. 启用DEBUG日志级别
2. 检查网络请求和响应
3. 验证数据格式转换

## 📈 性能影响

### 预期变化
- **网络流量**: 增加（因为包含截图）
- **处理时间**: 略微增加（截图获取和压缩）
- **内存使用**: 临时增加（截图处理）

### 优化建议
- 合理设置截图质量和大小
- 监控网络带宽使用
- 定期清理临时文件

## 🚀 部署建议

### 1. 测试环境验证
- 先在测试环境验证新接口
- 确认所有功能正常工作
- 验证性能表现

### 2. 生产环境部署
- 逐步替换客户端
- 监控错误日志
- 准备回滚方案

### 3. 监控指标
- 违规上报成功率
- 接口响应时间
- 错误日志数量

---

**更新版本**: v1.1.0  
**更新日期**: 2025-08-22  
**兼容版本**: 后端 v1.0.0+
