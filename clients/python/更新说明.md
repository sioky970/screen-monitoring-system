# Python客户端更新说明

## 📦 版本信息
- **版本**: v1.1.0
- **更新日期**: 2025-08-22
- **更新类型**: 功能增强 + 接口升级

## 🎯 主要更新

### 1. 违规上报接口升级
- ✅ **统一接口**: 使用 `POST /api/security/violations/report-with-screenshot`
- ✅ **数据格式**: 从JSON格式升级为multipart/form-data格式
- ✅ **截图集成**: 违规上报时自动包含截图证据
- ✅ **增强数据**: 更丰富的违规事件附加信息

### 2. 违规截图质量优化
- ✅ **高质量压缩**: 违规截图质量从60提升到90
- ✅ **更高分辨率**: 支持最大2560px分辨率（原1600px）
- ✅ **智能压缩**: 自适应质量调整和无损优化
- ✅ **专用配置**: 独立的违规截图配置参数

## 📁 核心文件更新

### 配置文件
- `config/config.yaml` - 新增违规截图专用配置
- `src/core/config.py` - 新增ViolationScreenshotConfig类

### 核心模块
- `src/modules/violation.py` - 重构违规上报逻辑，支持新接口
- `src/modules/blockchain_detector.py` - 更新违规数据格式
- `src/modules/screenshot.py` - 保持原有功能不变

### 文档和测试
- `违规上报接口更新说明.md` - 接口升级详细说明
- `违规截图高质量压缩方案.md` - 截图质量优化方案
- `违规截图质量优化更新总结.md` - 完整更新总结
- `test_violation_update.py` - 违规上报功能测试
- `test_config.py` - 配置加载测试
- `test_simple_violation.py` - 简单功能测试

## ⚙️ 配置变更

### 新增违规截图配置
```yaml
screenshot:
  # 普通截图配置（保持不变）
  quality: 60
  max_long_side: 1600
  max_file_size: 307200  # 300KB
  
  # 新增：违规截图专用配置
  violation:
    quality: 90                    # 高质量
    max_long_side: 2560           # 更高分辨率
    max_file_size: 2097152        # 2MB限制
    lossless_optimization: true   # 启用无损优化
    preserve_resolution: true     # 保留原始分辨率
```

## 🚀 部署指南

### 1. 备份现有配置
```bash
cp config/config.yaml config/config.yaml.backup
```

### 2. 更新配置文件
- 将新的配置项添加到现有配置文件中
- 或直接使用提供的新配置文件

### 3. 安装依赖
```bash
pip install -r requirements.txt
```

### 4. 测试验证
```bash
python test_config.py
python test_simple_violation.py
```

## 📊 性能影响

### 预期变化
- **违规截图文件大小**: 从~200KB增加到~800KB
- **网络传输**: 违规上报时间略微增加
- **处理性能**: 截图压缩时间增加100-200ms
- **存储需求**: 违规截图存储空间需求增加

### 优化建议
- 监控网络带宽使用情况
- 定期清理旧的违规截图
- 根据实际情况调整质量参数

## 🔧 兼容性说明

### 向后兼容
- ✅ 保持原有普通截图功能不变
- ✅ 保持原有配置文件结构
- ✅ 保持原有API调用方式
- ✅ 支持配置文件平滑升级

### 依赖要求
- **Python**: 3.7+
- **PIL (Pillow)**: 核心截图功能
- **requests**: HTTP请求库
- **mozjpeg-lossless-optimization**: 可选的无损优化

### 平台支持
- **Windows**: 完全支持
- **macOS**: 完全支持  
- **Linux**: 基础功能支持（截图功能有限）

## 🔍 故障排查

### 常见问题
1. **配置加载失败**: 检查YAML语法和缩进
2. **截图获取失败**: 在Linux环境下会使用占位文件
3. **网络连接失败**: 检查服务器地址和端口配置
4. **依赖包缺失**: 运行 `pip install -r requirements.txt`

### 调试方法
```python
# 启用详细日志
import logging
logging.basicConfig(level=logging.DEBUG)

# 测试配置加载
python test_config.py

# 测试违规上报
python test_simple_violation.py
```

## 📞 技术支持

如有问题，请检查：
1. 配置文件格式是否正确
2. 依赖包是否完整安装
3. 网络连接是否正常
4. 服务器端接口是否已更新

---

**更新完成**: 2025-08-22  
**版本**: v1.1.0  
**兼容性**: 向后兼容
