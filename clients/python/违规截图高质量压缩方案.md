# 违规截图高质量压缩方案

## 📋 方案概述

为了确保违规截图能够清晰地记录违规行为的证据，我们为违规截图实施了专门的高质量压缩方案，与普通监控截图区分开来。

## 🎯 设计目标

### 主要目标
- **高清晰度**: 确保违规内容清晰可见
- **证据价值**: 保持足够的细节用于违规认定
- **合理大小**: 在质量和文件大小间找到平衡
- **快速传输**: 确保上报过程的效率

### 质量要求
- **文字清晰**: 确保屏幕上的文字内容清晰可读
- **颜色准确**: 保持准确的颜色还原
- **细节保留**: 保留重要的视觉细节
- **无明显压缩伪影**: 避免明显的JPEG压缩痕迹

## ⚙️ 配置参数

### 违规截图专用配置

```yaml
screenshot:
  # 普通截图配置（监控用）
  quality: 60
  max_long_side: 1600
  max_file_size: 307200  # 300KB
  
  # 违规截图专用配置（证据用）
  violation:
    quality: 90                    # 高质量（85-95推荐）
    max_long_side: 2560           # 更高分辨率
    max_file_size: 2097152        # 2MB限制
    lossless_optimization: true   # 启用无损优化
    preserve_resolution: true     # 保留原始分辨率
```

### 参数说明

| 参数 | 普通截图 | 违规截图 | 说明 |
|------|----------|----------|------|
| **质量** | 60 | 90 | JPEG质量，违规截图使用高质量 |
| **分辨率** | 1600px | 2560px | 最大长边像素，违规截图支持更高分辨率 |
| **文件大小** | 300KB | 2MB | 最大文件大小限制 |
| **分辨率保留** | 否 | 是 | 违规截图优先保留原始分辨率 |
| **无损优化** | 否 | 是 | 使用MozJPEG进行无损优化 |

## 🔧 技术实现

### 高质量压缩算法

```python
def _get_current_screenshot(self) -> Optional[bytes]:
    """获取高质量违规截图"""
    
    # 1. 获取原始截图
    screenshot = ImageGrab.grab()
    
    # 2. 智能分辨率处理
    if not preserve_resolution and max_long_side > 0:
        # 使用LANCZOS算法进行高质量缩放
        screenshot = screenshot.resize(new_size, Image.Resampling.LANCZOS)
    
    # 3. 高质量JPEG压缩
    save_kwargs = {
        'format': 'JPEG',
        'quality': 90,              # 高质量
        'optimize': True,           # 启用优化
        'progressive': True,        # 渐进式JPEG
        'subsampling': 0,          # 禁用色度子采样
        'qtables': 'web_high'      # 高质量量化表
    }
    
    # 4. 自适应质量调整
    if file_size > max_size:
        # 逐步降低质量直到满足大小要求
        for quality in [85, 80, 75, 70]:
            # 重新压缩...
    
    # 5. 无损优化（可选）
    if lossless_optimization:
        optimized_data = mozjpeg_optimize(screenshot_data)
```

### 关键技术特性

#### 1. **高质量JPEG设置**
- **质量90**: 在质量和大小间的最佳平衡点
- **渐进式编码**: 提高网络传输体验
- **禁用色度子采样**: 保持更好的颜色质量
- **高质量量化表**: 减少压缩伪影

#### 2. **智能分辨率处理**
- **保留原始分辨率**: 优先保持原始分辨率
- **LANCZOS缩放**: 使用高质量缩放算法
- **智能尺寸限制**: 仅在必要时进行缩放

#### 3. **自适应质量调整**
- **大小检查**: 确保文件大小在限制范围内
- **渐进降质**: 85→80→75→70逐步调整
- **质量保底**: 最低质量不低于70

#### 4. **无损优化**
- **MozJPEG优化**: 在不损失质量的前提下减小文件大小
- **可选启用**: 可通过配置控制是否启用
- **错误处理**: 优化失败时使用原始数据

## 📊 质量对比

### 压缩效果对比

| 质量设置 | 文件大小 | 视觉质量 | 适用场景 |
|----------|----------|----------|----------|
| **60** | ~200KB | 中等 | 普通监控截图 |
| **75** | ~400KB | 良好 | 一般证据截图 |
| **85** | ~600KB | 很好 | 重要证据截图 |
| **90** | ~800KB | 优秀 | 违规证据截图 |
| **95** | ~1.2MB | 极佳 | 关键证据截图 |

### 分辨率处理策略

```
原始分辨率: 3840x2160 (4K)
├── 普通截图: 1600x900 (缩放)
└── 违规截图: 3840x2160 (保留) 或 2560x1440 (限制)
```

## 🚀 性能优化

### 压缩性能
- **处理时间**: 通常在100-300ms内完成
- **内存使用**: 临时增加约20-50MB
- **CPU占用**: 短时间内较高，但不影响系统响应

### 网络传输
- **文件大小**: 通常在500KB-1.5MB范围
- **传输时间**: 在良好网络条件下1-3秒
- **带宽要求**: 建议上行带宽不低于1Mbps

## 📈 质量评估

### 评估标准

#### 1. **文字清晰度**
- ✅ 12px以上文字清晰可读
- ✅ 8px以上文字基本可读
- ⚠️ 6px以下文字可能模糊

#### 2. **图像细节**
- ✅ 线条清晰，无明显锯齿
- ✅ 颜色过渡自然
- ✅ 细节纹理保留良好

#### 3. **压缩伪影**
- ✅ 无明显块状伪影
- ✅ 边缘清晰，无振铃效应
- ✅ 颜色无明显失真

### 质量检查清单

- [ ] 违规内容清晰可见
- [ ] 文字内容可以准确识别
- [ ] 颜色还原准确
- [ ] 无明显压缩痕迹
- [ ] 文件大小在合理范围内

## 🔍 故障排查

### 常见问题

#### 1. **截图质量不够清晰**
**原因**: 质量设置过低或分辨率被过度压缩
**解决**: 
- 提高 `violation.quality` 设置（建议85-95）
- 启用 `preserve_resolution`
- 增加 `max_long_side` 限制

#### 2. **文件过大**
**原因**: 质量设置过高或分辨率过大
**解决**:
- 适当降低质量设置
- 启用无损优化
- 调整分辨率限制

#### 3. **处理时间过长**
**原因**: 分辨率过高或优化算法耗时
**解决**:
- 适当限制分辨率
- 关闭无损优化
- 检查系统性能

### 调试方法

```python
# 启用详细日志
logging.getLogger('modules.violation').setLevel(logging.DEBUG)

# 检查配置
logger.info(f"违规截图质量: {config.screenshot.violation.quality}")
logger.info(f"文件大小限制: {config.screenshot.violation.max_file_size}")

# 分析截图结果
logger.info(f"截图大小: {len(screenshot_data)} bytes")
logger.info(f"压缩比: {compression_ratio:.3f}")
```

## 📝 最佳实践

### 配置建议

#### 1. **生产环境**
```yaml
violation:
  quality: 90
  max_long_side: 2560
  max_file_size: 1572864  # 1.5MB
  preserve_resolution: true
  lossless_optimization: true
```

#### 2. **测试环境**
```yaml
violation:
  quality: 85
  max_long_side: 1920
  max_file_size: 1048576  # 1MB
  preserve_resolution: false
  lossless_optimization: false
```

#### 3. **低带宽环境**
```yaml
violation:
  quality: 80
  max_long_side: 1600
  max_file_size: 524288   # 512KB
  preserve_resolution: false
  lossless_optimization: true
```

### 监控建议

1. **定期检查截图质量**
2. **监控文件大小分布**
3. **关注网络传输成功率**
4. **收集用户反馈**

---

**版本**: v1.0  
**更新日期**: 2025-08-22  
**适用版本**: Python客户端 v1.1.0+
