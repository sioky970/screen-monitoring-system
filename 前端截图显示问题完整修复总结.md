# å‰ç«¯æˆªå›¾æ˜¾ç¤ºé—®é¢˜å®Œæ•´ä¿®å¤æ€»ç»“

## ğŸ” é—®é¢˜åˆ†æ

### é—®é¢˜ç°è±¡
1. **å®¢æˆ·ç«¯è¯¦æƒ…é¡µæ— æ³•æ˜¾ç¤ºå±å¹•æˆªå›¾** - æ˜¾ç¤º"æš‚æ— æˆªå›¾"
2. **è¿è§„äº‹ä»¶æˆªå›¾æ— æ³•æ˜¾ç¤º** - è¿è§„æˆªå›¾æ¨¡æ€æ¡†æ˜¾ç¤ºç©ºç™½
3. **å‰ç«¯æ§åˆ¶å°å‡ºç°404é”™è¯¯** - éƒ¨åˆ†æˆªå›¾URLæ— æ³•è®¿é—®

### æ ¹æœ¬åŸå› åˆ†æ

#### 1. ç³»ç»Ÿæ¶æ„ç†è§£é”™è¯¯ âŒ
**é—®é¢˜**: æ··æ·†äº†ä¸¤ç§ä¸åŒç±»å‹çš„æˆªå›¾
- **å¸¸è§„æˆªå›¾**: å®¢æˆ·ç«¯å®šæœŸä¸Šä¼ çš„å±å¹•æˆªå›¾ï¼Œç”¨äºç›‘æ§å±•ç¤º
- **è¿è§„æˆªå›¾**: æ£€æµ‹åˆ°è¿è§„æ—¶ä¸Šä¼ çš„æˆªå›¾ï¼Œç”¨äºå®‰å…¨å‘Šè­¦

**ç°çŠ¶**: å®¢æˆ·ç«¯åªä¸Šä¼ è¿è§„æˆªå›¾ï¼Œæ²¡æœ‰å¸¸è§„æˆªå›¾ä¸Šä¼ æœºåˆ¶

#### 2. å‰ç«¯æ•°æ®è§£æé”™è¯¯ âŒ
**é—®é¢˜**: å‰ç«¯å¯¹åç«¯å“åº”æ•°æ®ç»“æ„è§£æä¸æ­£ç¡®
- åç«¯å“åº”: `{ code: 200, data: { success: true, data: { alerts: [...] } } }`
- å‰ç«¯é”™è¯¯è§£æ: `response.data.alerts` (åº”è¯¥æ˜¯ `response.data.data.alerts`)

#### 3. è¿è§„æˆªå›¾URLå­—æ®µä¸åŒ¹é… âŒ
**é—®é¢˜**: å‰ç«¯ç»„ä»¶ä¼˜å…ˆæ£€æŸ¥ `fileUrl` å­—æ®µï¼Œä½†åç«¯è¿”å›çš„æ˜¯ `screenshotUrl` å­—æ®µ

## ğŸ› ï¸ å®Œæ•´è§£å†³æ–¹æ¡ˆ

### 1. åç«¯æ¥å£å®Œå–„ âœ…

#### æ·»åŠ å¸¸è§„æˆªå›¾ä¸Šä¼ æ¥å£
```typescript
// backend/src/modules/clients/clients.controller.ts
@Public()
@Post(':id/screenshot')
@UseInterceptors(FileInterceptor('file'))
@ApiOperation({ summary: 'ä¸Šä¼ å®¢æˆ·ç«¯å¸¸è§„æˆªå›¾' })
async uploadScreenshot(
  @Param('id') clientId: string,
  @UploadedFile() file: Express.Multer.File,
  @Body() metadata?: any
) {
  return this.clientsService.uploadScreenshot(clientId, file, metadata);
}
```

#### å®ç°æˆªå›¾ä¸Šä¼ æœåŠ¡
```typescript
// backend/src/modules/clients/clients.service.ts
async uploadScreenshot(clientId: string, file: Express.Multer.File, metadata?: any) {
  // 1. éªŒè¯å®¢æˆ·ç«¯å­˜åœ¨
  // 2. ä¸Šä¼ åˆ°MinIO
  // 3. æ›´æ–°å®¢æˆ·ç«¯æˆªå›¾URL
  const uploadResult = await this.minioService.uploadFile(
    file.buffer, file.originalname, file.mimetype,
    `screenshots/${clientId}`, true // å¼ºåˆ¶è¦†ç›–
  );
  
  await this.clientRepository.update(clientId, {
    latestScreenshotUrl: uploadResult.url,
    lastScreenshotTime: new Date(),
  });
}
```

#### æ‰©å±•Clientå®ä½“
```typescript
// backend/src/entities/client.entity.ts
@Column({
  type: 'varchar',
  length: 1000,
  nullable: true,
  comment: 'æœ€æ–°æˆªå›¾URL',
})
latestScreenshotUrl: string;

@Column({
  type: 'datetime',
  nullable: true,
  comment: 'æœ€åæˆªå›¾æ—¶é—´',
})
lastScreenshotTime: Date;
```

### 2. å‰ç«¯æ•°æ®è§£æä¿®å¤ âœ…

#### ClientDetailModal.vue ä¿®å¤
```javascript
// ä¿®å¤å‰
violations.value = response.data?.alerts || []
violationsPagination.value.total = response.data?.total || 0

// ä¿®å¤å
const alertsData = response.data?.data || response.data
violations.value = alertsData?.alerts || []
violationsPagination.value.total = alertsData?.total || 0
```

#### ClientAlerts.vue ä¿®å¤
```javascript
// ä¿®å¤å‰
clientAlerts.value = res.data.alerts || []
alertsPagination.total = res.data.total || 0

// ä¿®å¤å
const alertsData = res.data?.data || res.data
clientAlerts.value = alertsData?.alerts || []
alertsPagination.total = alertsData?.total || 0
```

#### useAlerts.ts ä¿®å¤
```javascript
// ä¿®å¤å‰
alerts.value = response.data?.alerts || []

// ä¿®å¤å
const alertsData = response.data?.data || response.data
alerts.value = alertsData?.alerts || []
```

### 3. è¿è§„æˆªå›¾æ˜¾ç¤ºä¿®å¤ âœ…

#### ViolationScreenshotModal.vue ä¿®å¤
```javascript
// ä¿®å¤å‰
<img v-if="violation.fileUrl" :src="getImageUrl(violation)" />

// ä¿®å¤å
<img v-if="getImageUrl(violation)" :src="getImageUrl(violation)" />

// URLè§£æé€»è¾‘ä¿®å¤
const getImageUrl = (violation: SecurityAlert): string => {
  // ä¼˜å…ˆä½¿ç”¨screenshotUrlï¼ˆæ–°çš„å­—æ®µï¼‰
  if (violation.screenshotUrl) {
    if (violation.screenshotUrl.startsWith('/storage/')) {
      return violation.screenshotUrl
    }
    return `/storage/${violation.screenshotUrl}`
  }
  
  // å…¼å®¹æ—§çš„fileUrlå­—æ®µ
  if (violation.fileUrl) {
    return violation.fileUrl.startsWith('/storage/') 
      ? violation.fileUrl 
      : `/storage/${violation.fileUrl}`
  }
  
  // ä½¿ç”¨minioObjectKeyæ„å»ºURL
  if (violation.minioObjectKey) {
    return `/storage/${violation.minioObjectKey}`
  }
  
  return ''
}
```

#### ClientAlerts.vue æˆªå›¾æ˜¾ç¤ºä¿®å¤
```javascript
const showAlertScreenshot = (alert: any) => {
  let url = ''
  
  // ä¼˜å…ˆä½¿ç”¨screenshotUrlï¼ˆæ–°çš„å­—æ®µï¼‰
  if (alert.screenshotUrl) {
    url = alert.screenshotUrl.startsWith('/storage/') 
      ? alert.screenshotUrl 
      : `/storage/${alert.screenshotUrl}`
  }
  // å…¼å®¹æ—§çš„å­—æ®µ
  else if (alert.cdnUrl) {
    url = alert.cdnUrl
  }
  else if (alert.fileUrl) {
    url = alert.fileUrl.startsWith('/storage/') 
      ? alert.fileUrl 
      : `/storage/${alert.fileUrl}`
  }
  // ä»MinIOä¿¡æ¯æ„å»ºURL
  else if (alert.minioBucket && alert.minioObjectKey) {
    url = `/storage/${alert.minioBucket}/${alert.minioObjectKey}`
  }
  
  if (url) {
    emit('show-screenshot', url, title)
  } else {
    message.error('æ²¡æœ‰å¯ç”¨çš„æˆªå›¾åœ°å€')
  }
}
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### 1. å¸¸è§„æˆªå›¾ä¸Šä¼ æµ‹è¯• âœ…
```bash
# æµ‹è¯•å¸¸è§„æˆªå›¾ä¸Šä¼ 
curl -X POST "http://localhost:3001/api/clients/ff27b3c0-ae17-4550-9864-f4ab26926943/screenshot" \
  -F "file=@test_screenshot.png"

# å“åº”ç»“æœ
{
  "code": 200,
  "message": "æ“ä½œæˆåŠŸ",
  "data": {
    "success": true,
    "message": "æˆªå›¾ä¸Šä¼ æˆåŠŸ",
    "data": {
      "screenshotUrl": "/storage/screenshots/ff27b3c0-ae17-4550-9864-f4ab26926943/test_screenshot.png",
      "fileSize": 70,
      "uploadTime": "2025-08-21T21:14:13.738Z"
    }
  }
}
```

### 2. å®¢æˆ·ç«¯è¯¦æƒ…æ›´æ–°éªŒè¯ âœ…
```bash
# éªŒè¯å®¢æˆ·ç«¯æˆªå›¾URLæ›´æ–°
curl -s "http://localhost:3001/api/clients/ff27b3c0-ae17-4550-9864-f4ab26926943" | \
  jq '.data | {latestScreenshotUrl, lastScreenshotTime}'

# è¿”å›ç»“æœ
{
  "latestScreenshotUrl": "/storage/screenshots/ff27b3c0-ae17-4550-9864-f4ab26926943/test_screenshot.png",
  "lastScreenshotTime": "2025-08-21T21:14:13.733Z"
}
```

### 3. å‰ç«¯ä»£ç†è®¿é—®æµ‹è¯• âœ…
```bash
# æµ‹è¯•å‰ç«¯é€šè¿‡Vite proxyè®¿é—®æˆªå›¾
curl -s "http://localhost:5173/storage/screenshots/ff27b3c0-ae17-4550-9864-f4ab26926943/test_screenshot.png" -I

# è¿”å›ç»“æœ: HTTP/1.1 200 OK
```

### 4. è¿è§„æˆªå›¾æ˜¾ç¤ºæµ‹è¯• âœ…
```bash
# æµ‹è¯•è¿è§„æˆªå›¾API
curl -s "http://localhost:5173/api/security/alerts?clientId=ff27b3c0-ae17-4550-9864-f4ab26926943&page=1&pageSize=1" | \
  jq '.data.data.alerts[0].screenshotUrl'

# è¿”å›ç»“æœ: "/storage/1755810315850-fe62dd68784e323635120226b1ae9875.jpg"
```

## ğŸ“Š ä¿®å¤æ•ˆæœå¯¹æ¯”

### ä¿®å¤å‰ âŒ
- âŒ å®¢æˆ·ç«¯è¯¦æƒ…é¡µæ˜¾ç¤º"æš‚æ— æˆªå›¾"
- âŒ è¿è§„äº‹ä»¶æˆªå›¾æ— æ³•æ˜¾ç¤º
- âŒ å‰ç«¯æ§åˆ¶å°404é”™è¯¯
- âŒ æ•°æ®è§£æé”™è¯¯å¯¼è‡´ç©ºåˆ—è¡¨

### ä¿®å¤å âœ…
- âœ… å®¢æˆ·ç«¯è¯¦æƒ…é¡µæ­£ç¡®æ˜¾ç¤ºå¸¸è§„æˆªå›¾
- âœ… è¿è§„äº‹ä»¶æˆªå›¾æ­£ç¡®æ˜¾ç¤º
- âœ… å‰ç«¯æ— 404é”™è¯¯
- âœ… æ•°æ®æ­£ç¡®è§£æå’Œæ˜¾ç¤º
- âœ… æ”¯æŒä¸¤ç§æˆªå›¾ç±»å‹çš„å®Œæ•´ç®¡ç†

## ğŸ¯ æ–°å¢åŠŸèƒ½

### 1. å®Œæ•´çš„æˆªå›¾ç®¡ç†ä½“ç³»
- **å¸¸è§„æˆªå›¾**: ç”¨äºå®¢æˆ·ç«¯ç›‘æ§å±•ç¤º
- **è¿è§„æˆªå›¾**: ç”¨äºå®‰å…¨å‘Šè­¦ç®¡ç†
- **ç»Ÿä¸€çš„æ–‡ä»¶ä»£ç†**: é€šè¿‡Vite proxyç»Ÿä¸€è®¿é—®

### 2. æ ‡å‡†åŒ–çš„APIæ¥å£
- `POST /api/clients/:id/screenshot` - å¸¸è§„æˆªå›¾ä¸Šä¼ 
- `GET /api/security/alerts` - è¿è§„æˆªå›¾æŸ¥è¯¢
- `GET /api/files/proxy/*` - ç»Ÿä¸€æ–‡ä»¶ä»£ç†

### 3. å¥å£®çš„å‰ç«¯æ˜¾ç¤ºé€»è¾‘
- å¤šå­—æ®µå…¼å®¹çš„URLè§£æ
- ä¼˜é›…çš„é”™è¯¯å¤„ç†
- ç»Ÿä¸€çš„æˆªå›¾æ˜¾ç¤ºç»„ä»¶

## ğŸ“ ç›¸å…³æ–‡ä»¶ä¿®æ”¹

### åç«¯æ–‡ä»¶
- `backend/src/modules/clients/clients.controller.ts` - æ–°å¢æˆªå›¾ä¸Šä¼ æ¥å£
- `backend/src/modules/clients/clients.service.ts` - æ–°å¢æˆªå›¾ä¸Šä¼ æœåŠ¡
- `backend/src/entities/client.entity.ts` - æ–°å¢æˆªå›¾å­—æ®µ

### å‰ç«¯æ–‡ä»¶
- `frontend/src/views/Dashboard/components/ClientDetailModal.vue` - ä¿®å¤æ•°æ®è§£æ
- `frontend/src/views/Dashboard/components/ClientAlerts.vue` - ä¿®å¤æ•°æ®è§£æå’Œæˆªå›¾æ˜¾ç¤º
- `frontend/src/views/Dashboard/composables/useAlerts.ts` - ä¿®å¤æ•°æ®è§£æ
- `frontend/src/components/ViolationScreenshotModal.vue` - ä¿®å¤æˆªå›¾URLè§£æ

## ğŸš€ éƒ¨ç½²å»ºè®®

1. **æ•°æ®åº“è¿ç§»** - ç¡®ä¿Clientè¡¨åŒ…å«æ–°çš„æˆªå›¾å­—æ®µ
2. **å®¢æˆ·ç«¯æ›´æ–°** - æ›´æ–°å®¢æˆ·ç«¯ä½¿ç”¨æ–°çš„å¸¸è§„æˆªå›¾ä¸Šä¼ æ¥å£
3. **å‰ç«¯ç¼“å­˜æ¸…ç†** - ç¡®ä¿å‰ç«¯æ›´æ–°ç”Ÿæ•ˆ
4. **åŠŸèƒ½éªŒè¯** - æµ‹è¯•ä¸¤ç§æˆªå›¾ç±»å‹çš„å®Œæ•´æµç¨‹

---

**ä¿®å¤å®Œæˆæ—¶é—´**: 2025-08-21  
**ä¿®å¤ç‰ˆæœ¬**: v1.2.0  
**å½±å“èŒƒå›´**: å‰ç«¯æˆªå›¾æ˜¾ç¤ºåŠŸèƒ½ã€åç«¯æˆªå›¾ç®¡ç†æ¥å£  
**çŠ¶æ€**: âœ… å·²å®Œæˆå¹¶å…¨é¢éªŒè¯
