# 截图上传接口快速参考

## 🚀 快速开始

### 服务器地址
```
开发环境: http://localhost:3001
生产环境: http://your-server:3001
```

## 📋 核心接口

### 1. 客户端注册
```bash
POST /api/clients/register
Content-Type: application/json

{
  "hostname": "CLIENT-NAME",
  "ipAddress": "192.168.1.100",
  "osInfo": "Windows 10",
  "version": "1.0.0"
}

# 响应
{
  "success": true,
  "data": {
    "clientId": "uuid-string"
  }
}
```

### 2. 发送心跳
```bash
POST /api/clients/heartbeat
Content-Type: application/json

{
  "clientId": "uuid-string",
  "ipAddress": "192.168.1.100",
  "hostname": "CLIENT-NAME",
  "osInfo": "Windows 10",
  "version": "1.0.0"
}
```

### 3. 上传文件
```bash
POST /api/files/upload
Content-Type: multipart/form-data

file: [二进制文件]

# 响应
{
  "success": true,
  "data": {
    "url": "http://minio-url/file.jpg",
    "key": "files/2025/08/22/uuid-file.jpg"
  }
}
```

### 4. 查询安全告警
```bash
GET /api/security/alerts?clientId=uuid&page=1&pageSize=10

# 响应
{
  "success": true,
  "data": {
    "alerts": [...],
    "total": 8,
    "page": 1,
    "pageSize": 10
  }
}
```

### 5. 更新告警状态
```bash
PUT /api/security/alerts/16244/status
Content-Type: application/json

{
  "status": "confirmed",
  "remark": "已确认违规"
}
```

### 6. 批量忽略告警
```bash
POST /api/security/alerts/ignore-all
Content-Type: application/json

{
  "clientId": "uuid-string"
}
```

### 7. 违规上报（含截图）
```bash
POST /api/security/violations/report-with-screenshot
Content-Type: multipart/form-data

file: [截图文件]
clientId: uuid-string
violationType: BLOCKCHAIN_ADDRESS
violationContent: 1BvBMSEYstWetqTFn5Au4m4GFg7xJaNVN2
timestamp: 2025-08-22T10:30:00.000Z
additionalData: {"clipboardContent":"违规内容"}

# 响应
{
  "success": true,
  "alertId": 16239,
  "screenshotUrl": "http://minio-url/violation.jpg"
}
```

## 🔧 Python示例

### 完整客户端示例
```python
import requests
import json
import time
from datetime import datetime

class ScreenMonitorClient:
    def __init__(self, server_url="http://localhost:3001"):
        self.server_url = server_url
        self.client_id = None
        
    def register(self):
        """注册客户端"""
        url = f"{self.server_url}/api/clients/register"
        data = {
            "hostname": "PYTHON-CLIENT",
            "ipAddress": "192.168.1.100",
            "osInfo": "Windows 10",
            "version": "1.0.0"
        }
        
        response = requests.post(url, json=data)
        if response.status_code == 201:
            result = response.json()
            self.client_id = result['data']['clientId']
            print(f"注册成功: {self.client_id}")
            return True
        return False
    
    def heartbeat(self):
        """发送心跳"""
        if not self.client_id:
            return False
            
        url = f"{self.server_url}/api/clients/heartbeat"
        data = {
            "clientId": self.client_id,
            "ipAddress": "192.168.1.100",
            "hostname": "PYTHON-CLIENT",
            "osInfo": "Windows 10",
            "version": "1.0.0",
            "metadata": {
                "platform": "Python",
                "timestamp": datetime.now().isoformat()
            }
        }
        
        response = requests.post(url, json=data)
        return response.status_code == 200
    
    def upload_file(self, file_path):
        """上传文件"""
        url = f"{self.server_url}/api/files/upload"
        
        with open(file_path, 'rb') as f:
            files = {'file': f}
            response = requests.post(url, files=files)
        
        if response.status_code == 201:
            return response.json()['data']
        return None
    
    def report_violation(self, screenshot_path, violation_content):
        """上报违规事件"""
        if not self.client_id:
            return False
            
        url = f"{self.server_url}/api/security/violations/report-with-screenshot"
        
        data = {
            'clientId': self.client_id,
            'violationType': 'BLOCKCHAIN_ADDRESS',
            'violationContent': violation_content,
            'timestamp': datetime.now().isoformat() + 'Z',
            'additionalData': json.dumps({
                'clipboardContent': f'发现违规: {violation_content}',
                'platform': 'Python'
            })
        }
        
        with open(screenshot_path, 'rb') as f:
            files = {'file': f}
            response = requests.post(url, files=files, data=data)
        
        if response.status_code == 201:
            return response.json()
        return None

# 使用示例
if __name__ == "__main__":
    client = ScreenMonitorClient()
    
    # 1. 注册客户端
    if client.register():
        print("✅ 客户端注册成功")
        
        # 2. 发送心跳
        if client.heartbeat():
            print("✅ 心跳发送成功")
        
        # 3. 上传文件
        file_info = client.upload_file("screenshot.jpg")
        if file_info:
            print(f"✅ 文件上传成功: {file_info['url']}")
        
        # 4. 上报违规
        violation_result = client.report_violation(
            "violation.jpg", 
            "1BvBMSEYstWetqTFn5Au4m4GFg7xJaNVN2"
        )
        if violation_result:
            print(f"✅ 违规上报成功: 告警ID {violation_result['alertId']}")
```

## 🔍 快速测试

### 使用curl测试所有接口
```bash
#!/bin/bash

SERVER="http://localhost:3001"

# 1. 注册客户端
echo "=== 注册客户端 ==="
RESPONSE=$(curl -s -X POST $SERVER/api/clients/register \
  -H "Content-Type: application/json" \
  -d '{"hostname":"TEST","ipAddress":"127.0.0.1","osInfo":"Linux","version":"1.0.0"}')

CLIENT_ID=$(echo $RESPONSE | jq -r '.data.clientId')
echo "客户端ID: $CLIENT_ID"

# 2. 心跳测试
echo -e "\n=== 心跳测试 ==="
curl -X POST $SERVER/api/clients/heartbeat \
  -H "Content-Type: application/json" \
  -d "{\"clientId\":\"$CLIENT_ID\",\"ipAddress\":\"127.0.0.1\"}"

# 3. 创建测试图片并上传
echo -e "\n=== 文件上传测试 ==="
echo "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8/5+hHgAHggJ/PchI7wAAAABJRU5ErkJggg==" | base64 -d > test.png
curl -X POST $SERVER/api/files/upload -F "file=@test.png"

# 4. 违规上报测试
echo -e "\n=== 违规上报测试 ==="
curl -X POST $SERVER/api/security/violations/report-with-screenshot \
  -F "file=@test.png" \
  -F "clientId=$CLIENT_ID" \
  -F "violationType=BLOCKCHAIN_ADDRESS" \
  -F "violationContent=1BvBMSEYstWetqTFn5Au4m4GFg7xJaNVN2" \
  -F "timestamp=$(date -u +%Y-%m-%dT%H:%M:%S.000Z)" \
  -F "additionalData={\"test\":true}"

# 清理
rm -f test.png
```

## ⚠️ 注意事项

### 文件要求
- **格式**: JPG, PNG
- **大小**: ≤ 2MB
- **分辨率**: 建议 ≤ 2560px

### 必填参数
- **clientId**: 必须先注册获取
- **timestamp**: ISO 8601格式
- **violationType**: 当前支持 `BLOCKCHAIN_ADDRESS`

### 错误处理
- **400**: 参数错误
- **404**: 客户端不存在
- **413**: 文件过大
- **500**: 服务器错误

## 📚 相关文档

- [完整接口文档](./屏幕监控截图上传接口文档.md)
- [Python客户端文档](./clients/python/README.md)
- [API在线文档](http://localhost:3001/api-docs)

---
**快速参考版本**: v1.0 | **更新**: 2025-08-22
