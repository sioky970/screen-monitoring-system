# 屏幕监控截图上传接口文档

## 📋 接口概述

屏幕监控系统提供多个截图上传接口，用于客户端上传屏幕截图、违规截图和心跳数据。本文档详细介绍各个接口的使用方法、参数格式和响应结构。

## 🔗 接口列表

### 1. 通用文件上传接口
- **接口地址**: `POST /api/files/upload`
- **用途**: 通用文件上传，支持各种文件类型
- **认证**: 无需认证

### 2. 违规上报接口（含截图）
- **接口地址**: `POST /api/security/violations/report-with-screenshot`
- **用途**: 客户端上报违规事件并同时上传违规截图
- **认证**: 无需认证

### 3. 安全告警查询接口
- **接口地址**: `GET /api/security/alerts`
- **用途**: 查询安全告警列表，支持分页和筛选
- **认证**: 无需认证

### 4. 安全告警状态更新接口
- **接口地址**: `PUT /api/security/alerts/:id/status`
- **用途**: 更新告警状态（确认、忽略、误报等）
- **认证**: 无需认证

### 5. 批量忽略告警接口
- **接口地址**: `POST /api/security/alerts/ignore-all`
- **用途**: 忽略指定客户端的所有未处理违规
- **认证**: 无需认证

### 6. 客户端心跳接口
- **接口地址**: `POST /api/clients/heartbeat`
- **用途**: 客户端发送心跳信息，更新在线状态
- **认证**: 无需认证

### 7. 客户端注册接口
- **接口地址**: `POST /api/clients/register`
- **用途**: 新客户端注册，获取唯一客户端ID
- **认证**: 无需认证

## 📝 接口详细说明

### 1. 通用文件上传接口

#### 基本信息
```
POST /api/files/upload
Content-Type: multipart/form-data
```

#### 请求参数
| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| `file` | File | ✅ | 要上传的文件 | screenshot.jpg |

#### 请求示例
```bash
curl -X POST http://localhost:3001/api/files/upload \
  -F "file=@screenshot.jpg"
```

#### 响应格式
```json
{
  "success": true,
  "data": {
    "key": "files/2025/08/22/uuid-filename.jpg",
    "url": "http://localhost:9000/monitoring-screenshots/files/2025/08/22/uuid-filename.jpg",
    "size": 245760,
    "contentType": "image/jpeg"
  }
}
```

### 2. 安全告警查询接口

#### 基本信息
```
GET /api/security/alerts
Content-Type: application/json
```

#### 请求参数
| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| `clientId` | String | ❌ | 客户端ID筛选 | `a1b2c3d4-e5f6-7890-abcd-ef1234567890` |
| `page` | Number | ❌ | 页码 | `1` |
| `pageSize` | Number | ❌ | 每页数量 | `20` |
| `status` | String | ❌ | 告警状态筛选 | `pending` |
| `alertType` | String | ❌ | 告警类型筛选 | `BLOCKCHAIN_ADDRESS` |
| `startDate` | String | ❌ | 开始日期 | `2025-08-01` |
| `endDate` | String | ❌ | 结束日期 | `2025-08-31` |

#### 请求示例
```bash
curl -X GET "http://localhost:3001/api/security/alerts?clientId=ff27b3c0-ae17-4550-9864-f4ab26926943&page=1&pageSize=10"
```

#### 响应格式
```json
{
  "success": true,
  "data": {
    "alerts": [
      {
        "id": 16244,
        "alertId": "e40aaa87-2d4b-4912-ab13-30eba79146d2",
        "clientId": "ff27b3c0-ae17-4550-9864-f4ab26926943",
        "clientName": "客户端-VM-0-12-ubuntu",
        "alertType": "BLOCKCHAIN_ADDRESS",
        "detectedAddress": "1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa",
        "addressType": "BITCOIN",
        "clipboardContent": "",
        "screenshotUrl": "/storage/screenshots/client-id/violation.jpg",
        "status": "pending",
        "riskLevel": "HIGH",
        "createdAt": "2025-08-21T19:46:46.000Z",
        "remark": null
      }
    ],
    "total": 8,
    "page": 1,
    "pageSize": 10,
    "totalPages": 1
  }
}
```

### 3. 安全告警状态更新接口

#### 基本信息
```
PUT /api/security/alerts/:id/status
Content-Type: application/json
```

#### 请求参数
| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| `status` | String | ✅ | 新状态 | `confirmed` |
| `remark` | String | ❌ | 处理备注 | `已确认为真实违规` |

#### 状态值说明
- `pending` - 待处理
- `confirmed` - 已确认
- `false_positive` - 误报
- `ignored` - 已忽略
- `resolved` - 已解决

#### 请求示例
```bash
curl -X PUT http://localhost:3001/api/security/alerts/16244/status \
  -H "Content-Type: application/json" \
  -d '{"status": "confirmed", "remark": "已确认为真实违规"}'
```

#### 响应格式
```json
{
  "success": true,
  "message": "告警状态更新成功"
}
```

### 4. 批量忽略告警接口

#### 基本信息
```
POST /api/security/alerts/ignore-all
Content-Type: application/json
```

#### 请求参数
| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| `clientId` | String | ✅ | 客户端ID | `a1b2c3d4-e5f6-7890-abcd-ef1234567890` |

#### 请求示例
```bash
curl -X POST http://localhost:3001/api/security/alerts/ignore-all \
  -H "Content-Type: application/json" \
  -d '{"clientId": "ff27b3c0-ae17-4550-9864-f4ab26926943"}'
```

#### 响应格式
```json
{
  "success": true,
  "message": "已忽略 5 条未处理违规",
  "affected": 5
}
```

### 5. 违规上报接口（含截图）

#### 基本信息
```
POST /api/security/violations/report-with-screenshot
Content-Type: multipart/form-data
```

#### 请求参数
| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| `file` | File | ✅ | 违规截图文件 | violation_screenshot.jpg |
| `clientId` | String | ✅ | 客户端唯一标识符 | `a1b2c3d4-e5f6-7890-abcd-ef1234567890` |
| `violationType` | String | ✅ | 违规类型 | `BLOCKCHAIN_ADDRESS` |
| `violationContent` | String | ✅ | 违规内容 | `1BvBMSEYstWetqTFn5Au4m4GFg7xJaNVN2` |
| `timestamp` | String | ✅ | 违规发生时间 | `2025-08-22T10:30:00.000Z` |
| `additionalData` | String | ❌ | 附加数据（JSON字符串） | `{"clipboardContent":"..."}` |

#### 请求示例
```bash
curl -X POST http://localhost:3001/api/security/violations/report-with-screenshot \
  -F "file=@violation_screenshot.jpg" \
  -F "clientId=a1b2c3d4-e5f6-7890-abcd-ef1234567890" \
  -F "violationType=BLOCKCHAIN_ADDRESS" \
  -F "violationContent=1BvBMSEYstWetqTFn5Au4m4GFg7xJaNVN2" \
  -F "timestamp=2025-08-22T10:30:00.000Z" \
  -F "additionalData={\"clipboardContent\":\"发现比特币地址\"}"
```

#### 响应格式
```json
{
  "success": true,
  "message": "违规事件上报成功",
  "alertId": 16239,
  "screenshotUrl": "http://localhost:9000/monitoring-screenshots/violations/client-id/2025-08-22T10-30-00-000Z_uuid.jpg"
}
```

### 3. 客户端心跳接口

#### 基本信息
```
POST /api/clients/heartbeat
Content-Type: application/json
```

#### 请求参数
| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| `clientId` | String | ✅ | 客户端ID | `client-001` |
| `ipAddress` | String | ❌ | 客户端IP地址 | `192.168.1.100` |
| `hostname` | String | ❌ | 客户端主机名 | `DESKTOP-ABC123` |
| `osInfo` | String | ❌ | 操作系统信息 | `Windows 10` |
| `version` | String | ❌ | 客户端版本 | `1.0.0` |
| `metadata` | Object | ❌ | 额外的客户端信息 | `{"platform": "Python"}` |

#### 请求示例
```bash
curl -X POST http://localhost:3001/api/clients/heartbeat \
  -H "Content-Type: application/json" \
  -d '{
    "clientId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
    "ipAddress": "192.168.1.100",
    "hostname": "DESKTOP-ABC123",
    "osInfo": "Windows 10",
    "version": "1.0.0",
    "metadata": {
      "platform": "Python",
      "capabilities": {
        "screenshot": true,
        "clipboard_monitor": true
      }
    }
  }'
```

#### 响应格式
```json
{
  "success": true,
  "clientStatus": "online",
  "lastSeen": "2025-08-22T10:30:00.000Z",
  "message": "心跳处理成功"
}
```

### 4. 客户端注册接口

#### 基本信息
```
POST /api/clients/register
Content-Type: application/json
```

#### 请求参数
| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| `hostname` | String | ❌ | 主机名 | `DESKTOP-ABC123` |
| `ipAddress` | String | ❌ | IP地址 | `192.168.1.100` |
| `osInfo` | String | ❌ | 操作系统信息 | `Windows 10` |
| `version` | String | ❌ | 客户端版本 | `1.0.0` |

#### 请求示例
```bash
curl -X POST http://localhost:3001/api/clients/register \
  -H "Content-Type: application/json" \
  -d '{
    "hostname": "DESKTOP-ABC123",
    "ipAddress": "192.168.1.100",
    "osInfo": "Windows 10",
    "version": "1.0.0"
  }'
```

#### 响应格式
```json
{
  "success": true,
  "data": {
    "clientId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
    "message": "客户端注册成功"
  }
}
```

## 🔧 Python客户端使用示例

### 1. 客户端注册
```python
import requests
import json

def register_client():
    url = "http://localhost:3001/api/clients/register"
    data = {
        "hostname": "PYTHON-CLIENT",
        "ipAddress": "192.168.1.100",
        "osInfo": "Windows 10",
        "version": "1.0.0"
    }
    
    response = requests.post(url, json=data)
    if response.status_code == 201:
        result = response.json()
        client_id = result['data']['clientId']
        print(f"注册成功，客户端ID: {client_id}")
        return client_id
    else:
        print(f"注册失败: {response.text}")
        return None
```

### 2. 发送心跳
```python
def send_heartbeat(client_id):
    url = "http://localhost:3001/api/clients/heartbeat"
    data = {
        "clientId": client_id,
        "ipAddress": "192.168.1.100",
        "hostname": "PYTHON-CLIENT",
        "osInfo": "Windows 10",
        "version": "1.0.0",
        "metadata": {
            "platform": "Python",
            "capabilities": {
                "screenshot": True,
                "clipboard_monitor": True,
                "blockchain_detection": True
            }
        }
    }
    
    response = requests.post(url, json=data)
    if response.status_code == 200:
        print("心跳发送成功")
        return True
    else:
        print(f"心跳发送失败: {response.text}")
        return False
```

### 3. 上传文件
```python
def upload_file(file_path):
    url = "http://localhost:3001/api/files/upload"
    
    with open(file_path, 'rb') as f:
        files = {'file': (file_path, f, 'image/jpeg')}
        response = requests.post(url, files=files)
    
    if response.status_code == 201:
        result = response.json()
        print(f"文件上传成功: {result['data']['url']}")
        return result['data']
    else:
        print(f"文件上传失败: {response.text}")
        return None
```

### 4. 上报违规事件
```python
def report_violation(client_id, screenshot_path, violation_content):
    url = "http://localhost:3001/api/security/violations/report-with-screenshot"
    
    # 准备表单数据
    data = {
        'clientId': client_id,
        'violationType': 'BLOCKCHAIN_ADDRESS',
        'violationContent': violation_content,
        'timestamp': datetime.now().isoformat() + 'Z',
        'additionalData': json.dumps({
            'clipboardContent': f'发现区块链地址: {violation_content}',
            'detectionMethod': 'clipboard_monitor',
            'riskLevel': 'HIGH'
        })
    }
    
    # 准备文件数据
    with open(screenshot_path, 'rb') as f:
        files = {'file': (f'violation_{int(time.time())}.jpg', f, 'image/jpeg')}
        response = requests.post(url, files=files, data=data)
    
    if response.status_code == 201:
        result = response.json()
        print(f"违规上报成功，告警ID: {result['alertId']}")
        return result
    else:
        print(f"违规上报失败: {response.text}")
        return None
```

## 📊 错误处理

### 常见错误码
| 状态码 | 说明 | 解决方法 |
|--------|------|----------|
| 400 | 请求参数错误 | 检查请求参数格式和必填字段 |
| 404 | 客户端不存在 | 先调用注册接口获取客户端ID |
| 413 | 文件过大 | 压缩文件或检查文件大小限制 |
| 500 | 服务器内部错误 | 检查服务器日志，联系技术支持 |

### 错误响应格式
```json
{
  "success": false,
  "message": "错误描述",
  "error": "详细错误信息",
  "statusCode": 400
}
```

## 🔒 安全说明

### 1. 认证机制
- 当前所有接口都无需认证
- 建议在生产环境中添加适当的认证机制
- 可以通过IP白名单限制访问

### 2. 数据验证
- 所有接口都有严格的参数验证
- 文件类型和大小都有限制
- 客户端ID必须是有效的UUID格式

### 3. 存储安全
- 文件存储在MinIO对象存储中
- 支持访问控制和权限管理
- 违规截图永久保存，普通截图可配置保留策略

## 📈 性能优化

### 1. 文件压缩
- 建议客户端在上传前压缩截图
- 支持JPEG质量调整
- 推荐分辨率不超过2560px

### 2. 批量操作
- 支持异步上传队列
- 可配置并发上传数量
- 自动重试机制

### 3. 缓存策略
- 使用Redis缓存客户端状态
- MinIO支持CDN加速
- 支持预签名URL直传

## 🧪 接口测试

### 使用Postman测试

#### 1. 测试文件上传
```
POST http://localhost:3001/api/files/upload
Body: form-data
- file: [选择文件] screenshot.jpg
```

#### 2. 测试违规上报
```
POST http://localhost:3001/api/security/violations/report-with-screenshot
Body: form-data
- file: [选择文件] violation.jpg
- clientId: a1b2c3d4-e5f6-7890-abcd-ef1234567890
- violationType: BLOCKCHAIN_ADDRESS
- violationContent: 1BvBMSEYstWetqTFn5Au4m4GFg7xJaNVN2
- timestamp: 2025-08-22T10:30:00.000Z
- additionalData: {"clipboardContent":"测试违规"}
```

#### 3. 测试心跳
```
POST http://localhost:3001/api/clients/heartbeat
Body: raw (JSON)
{
  "clientId": "a1b2c3d4-e5f6-7890-abcd-ef1234567890",
  "ipAddress": "192.168.1.100",
  "hostname": "TEST-CLIENT",
  "osInfo": "Windows 10",
  "version": "1.0.0"
}
```

### 使用curl测试

#### 完整的客户端流程测试
```bash
#!/bin/bash

# 1. 注册客户端
echo "=== 注册客户端 ==="
REGISTER_RESPONSE=$(curl -s -X POST http://localhost:3001/api/clients/register \
  -H "Content-Type: application/json" \
  -d '{
    "hostname": "TEST-CLIENT",
    "ipAddress": "192.168.1.100",
    "osInfo": "Linux Ubuntu 20.04",
    "version": "1.0.0"
  }')

echo "注册响应: $REGISTER_RESPONSE"

# 提取客户端ID
CLIENT_ID=$(echo $REGISTER_RESPONSE | jq -r '.data.clientId')
echo "客户端ID: $CLIENT_ID"

# 2. 发送心跳
echo -e "\n=== 发送心跳 ==="
HEARTBEAT_RESPONSE=$(curl -s -X POST http://localhost:3001/api/clients/heartbeat \
  -H "Content-Type: application/json" \
  -d "{
    \"clientId\": \"$CLIENT_ID\",
    \"ipAddress\": \"192.168.1.100\",
    \"hostname\": \"TEST-CLIENT\",
    \"osInfo\": \"Linux Ubuntu 20.04\",
    \"version\": \"1.0.0\",
    \"metadata\": {
      \"platform\": \"Linux\",
      \"test\": true
    }
  }")

echo "心跳响应: $HEARTBEAT_RESPONSE"

# 3. 上传测试文件
echo -e "\n=== 上传测试文件 ==="
# 创建测试图片文件
echo "创建测试图片..."
convert -size 800x600 xc:white -pointsize 30 -fill black \
  -annotate +50+300 "Test Screenshot $(date)" test_screenshot.jpg

UPLOAD_RESPONSE=$(curl -s -X POST http://localhost:3001/api/files/upload \
  -F "file=@test_screenshot.jpg")

echo "上传响应: $UPLOAD_RESPONSE"

# 4. 上报违规事件
echo -e "\n=== 上报违规事件 ==="
VIOLATION_RESPONSE=$(curl -s -X POST http://localhost:3001/api/security/violations/report-with-screenshot \
  -F "file=@test_screenshot.jpg" \
  -F "clientId=$CLIENT_ID" \
  -F "violationType=BLOCKCHAIN_ADDRESS" \
  -F "violationContent=1BvBMSEYstWetqTFn5Au4m4GFg7xJaNVN2" \
  -F "timestamp=$(date -u +%Y-%m-%dT%H:%M:%S.000Z)" \
  -F "additionalData={\"clipboardContent\":\"测试违规事件\",\"testMode\":true}")

echo "违规上报响应: $VIOLATION_RESPONSE"

# 清理测试文件
rm -f test_screenshot.jpg

echo -e "\n=== 测试完成 ==="
```

## 📋 接口规范

### 1. 请求头规范
```
Content-Type: multipart/form-data  # 文件上传接口
Content-Type: application/json     # JSON数据接口
User-Agent: ScreenMonitor-Client/1.0.0
```

### 2. 文件命名规范
- **普通截图**: `screenshot_YYYYMMDD_HHMMSS.jpg`
- **违规截图**: `violation_YYYYMMDD_HHMMSS.jpg`
- **文件大小**: 建议不超过2MB
- **图片格式**: 支持JPG、PNG，推荐JPG
- **图片质量**: 建议JPEG质量60-90

### 3. 时间格式规范
- **标准格式**: ISO 8601格式
- **示例**: `2025-08-22T10:30:00.000Z`
- **时区**: 统一使用UTC时间

### 4. 客户端ID规范
- **格式**: UUID v4格式
- **示例**: `a1b2c3d4-e5f6-7890-abcd-ef1234567890`
- **生成**: 服务器端生成，客户端保存

## 🔄 接口版本管理

### 当前版本: v1.0
- 支持基本的文件上传功能
- 支持违规事件上报
- 支持客户端心跳和注册

### 计划版本: v1.1
- 添加截图+心跳合并接口 `upload-with-heartbeat`
- 支持批量文件上传
- 增加文件预签名URL功能

### 版本兼容性
- 向后兼容所有v1.x版本
- 新增接口不影响现有功能
- 废弃接口会提前通知

## 📞 技术支持

### 常见问题
1. **Q: 上传文件失败，提示文件过大**
   A: 检查文件大小，建议压缩后再上传，单文件限制2MB

2. **Q: 客户端ID无效**
   A: 确保先调用注册接口获取有效的客户端ID

3. **Q: 心跳发送失败**
   A: 检查网络连接和服务器状态，确认客户端ID有效

4. **Q: 违规上报没有创建告警**
   A: 检查violationType和violationContent格式是否正确

### 调试建议
1. 启用详细日志记录
2. 检查网络连接状态
3. 验证请求参数格式
4. 查看服务器端日志

### 联系方式
- **技术支持**: 查看服务器日志获取详细错误信息
- **API文档**: http://localhost:3001/api-docs
- **系统状态**: http://localhost:3001/health

---

**文档版本**: v1.0
**更新日期**: 2025-08-22
**适用版本**: 后端 v1.0.0+
**维护者**: 屏幕监控系统开发团队
