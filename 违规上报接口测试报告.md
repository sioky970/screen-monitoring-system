# è¿è§„ä¸ŠæŠ¥æ¥å£æµ‹è¯•æŠ¥å‘Š

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è®°å½•äº†å±å¹•ç›‘æ§ç³»ç»Ÿåç«¯è¿è§„ä¸ŠæŠ¥æ¥å£çš„å®Œæ•´æµ‹è¯•è¿‡ç¨‹å’Œç»“æœã€‚

## ğŸš€ ç¯å¢ƒå‡†å¤‡

### 1. åç«¯æœåŠ¡å¯åŠ¨

```bash
# è¿›å…¥åç«¯ç›®å½•
cd backend

# å¯åŠ¨å¼€å‘æœåŠ¡
npm run start:dev
```

### 2. åŸºç¡€è®¾æ–½æœåŠ¡çŠ¶æ€

ç¡®ä¿ä»¥ä¸‹Dockerå®¹å™¨æ­£åœ¨è¿è¡Œï¼š
- **MySQLæ•°æ®åº“**: `screen-monitor-mysql` (ç«¯å£3306)
- **Redisç¼“å­˜**: `screen-monitor-redis` (ç«¯å£6379)  
- **MinIOå¯¹è±¡å­˜å‚¨**: `screen-monitor-minio` (ç«¯å£9000/9001)
- **Admineræ•°æ®åº“ç®¡ç†**: `screen-monitor-adminer` (ç«¯å£8080)

```bash
# æ£€æŸ¥å®¹å™¨çŠ¶æ€
docker ps
```

## ğŸ”§ æ¥å£ä¿¡æ¯

### ä¸»è¦è¿è§„ä¸ŠæŠ¥æ¥å£

- **æ¥å£åœ°å€**: `POST /api/security/violations/report-with-screenshot`
- **è®¤è¯æ–¹å¼**: æ— éœ€è®¤è¯ (@Public)
- **è¯·æ±‚æ ¼å¼**: `multipart/form-data`
- **æœåŠ¡ç«¯å£**: `3001`

### è¯·æ±‚å‚æ•°

| å‚æ•°å | ç±»å‹ | å¿…å¡« | è¯´æ˜ |
|--------|------|------|------|
| `file` | File | âœ… | è¿è§„æˆªå›¾æ–‡ä»¶ |
| `clientId` | String | âœ… | å®¢æˆ·ç«¯ID (UUIDæ ¼å¼) |
| `violationType` | String | âœ… | è¿è§„ç±»å‹ (å¦‚ "BLOCKCHAIN_ADDRESS") |
| `violationContent` | String | âœ… | è¿è§„å†…å®¹ (å¦‚åŒºå—é“¾åœ°å€) |
| `timestamp` | String | âœ… | è¿è§„å‘ç”Ÿæ—¶é—´ (ISO 8601æ ¼å¼) |
| `additionalData` | String | âŒ | é™„åŠ æ•°æ® (JSONå­—ç¬¦ä¸²) |

## ğŸ§ª æµ‹è¯•ç”¨ä¾‹

### æµ‹è¯•è„šæœ¬

åˆ›å»ºæµ‹è¯•è„šæœ¬ `test_violation_api.sh`:

```bash
#!/bin/bash

echo "=== æµ‹è¯•è¿è§„ä¸ŠæŠ¥æ¥å£ ==="
echo "æ¥å£: POST /api/security/violations/report-with-screenshot"
echo ""

# å‘é€è¯·æ±‚å¹¶è·å–å“åº”
response=$(curl -s -w "\nHTTP_CODE:%{http_code}\n" -X POST "http://localhost:3001/api/security/violations/report-with-screenshot" \
  -F "file=@1.jpg" \
  -F "clientId=65ffa6a7-2f4b-4ab2-b0d6-8db48840e520" \
  -F "violationType=BLOCKCHAIN_ADDRESS" \
  -F "violationContent=0x742d35Cc6634C0532925a3b8D4C9db96DfbBfC88" \
  -F "timestamp=2025-08-22T03:11:00.000Z" \
  -F "additionalData={\"clipboardContent\":\"æµ‹è¯•è¿è§„ï¼šå‘ç°ä»¥å¤ªåŠåœ°å€\",\"applicationName\":\"æµ‹è¯•åº”ç”¨\"}")

# åˆ†ç¦»å“åº”ä½“å’ŒçŠ¶æ€ç 
http_code=$(echo "$response" | grep "HTTP_CODE:" | cut -d: -f2)
response_body=$(echo "$response" | grep -v "HTTP_CODE:")

echo "HTTPçŠ¶æ€ç : $http_code"
echo "å“åº”å†…å®¹:"
echo "$response_body" | python3 -m json.tool 2>/dev/null || echo "$response_body"
echo ""
echo "=== æµ‹è¯•å®Œæˆ ==="
```

### æ‰§è¡Œæµ‹è¯•

```bash
# ç»™è„šæœ¬æ‰§è¡Œæƒé™
chmod +x test_violation_api.sh

# è¿è¡Œæµ‹è¯•
./test_violation_api.sh
```

## ğŸ“Š æµ‹è¯•ç»“æœ

### âœ… æˆåŠŸå“åº”ç¤ºä¾‹

**HTTPçŠ¶æ€ç **: `201`

**å“åº”å†…å®¹**:
```json
{
    "code": 200,
    "message": "æ“ä½œæˆåŠŸ",
    "data": {
        "success": true,
        "message": "è¿è§„äº‹ä»¶ä¸ŠæŠ¥æˆåŠŸ",
        "alertId": 16238,
        "screenshotUrl": "/storage/screenshots/65ffa6a7-2f4b-4ab2-b0d6-8db48840e520/alerts/1755755271554-478881c9f4893b836be9bbe05fdd0953.jpg"
    },
    "success": true,
    "timestamp": "2025-08-21T19:11:30.106Z"
}
```

### ğŸ” æµ‹è¯•çš„åŒºå—é“¾åœ°å€ç±»å‹

æˆ‘ä»¬æˆåŠŸæµ‹è¯•äº†ä»¥ä¸‹ç±»å‹çš„åŒºå—é“¾åœ°å€ï¼š

1. **æ¯”ç‰¹å¸åœ°å€**: `1BvBMSEYstWetqTFn5Au4m4GFg7xJaNVN2`
2. **æ¯”ç‰¹å¸åœ°å€**: `1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa`
3. **æ¯”ç‰¹å¸Bech32åœ°å€**: `bc1qxy2kgdygjrsqtzq2n0yrf2493p83kkfjhx0wlh`
4. **æ¯”ç‰¹å¸P2SHåœ°å€**: `3J98t1WpEZ73CNmQviecrnyiWrnqRhWNLy`
5. **ä»¥å¤ªåŠåœ°å€**: `0x742d35Cc6634C0532925a3b8D4C9db96DfbBfC88`

### ğŸ“ˆ æ€§èƒ½æŒ‡æ ‡

- **å“åº”æ—¶é—´**: 30-100ms
- **å¹¶å‘æ”¯æŒ**: âœ… æ”¯æŒå¤šä¸ªå¹¶å‘è¯·æ±‚
- **æ–‡ä»¶ä¸Šä¼ **: âœ… æˆåŠŸä¸Šä¼ åˆ°MinIOå­˜å‚¨
- **æ•°æ®åº“æ“ä½œ**: âœ… æˆåŠŸåˆ›å»ºå®‰å…¨å‘Šè­¦è®°å½•

## ğŸ”§ åŠŸèƒ½éªŒè¯

### âœ… å·²éªŒè¯åŠŸèƒ½

1. **æ–‡ä»¶ä¸Šä¼ å¤„ç†**
   - æ”¯æŒå›¾ç‰‡æ–‡ä»¶ä¸Šä¼ 
   - è‡ªåŠ¨ä¿å­˜åˆ°MinIOå¯¹è±¡å­˜å‚¨
   - ç”Ÿæˆç‹¬ç«‹çš„è¿è§„æˆªå›¾æ–‡ä»¶è·¯å¾„

2. **å®¢æˆ·ç«¯éªŒè¯**
   - éªŒè¯å®¢æˆ·ç«¯IDçš„æœ‰æ•ˆæ€§
   - ç¡®ä¿å®¢æˆ·ç«¯å­˜åœ¨äºç³»ç»Ÿä¸­

3. **è¿è§„å†…å®¹è§£æ**
   - è‡ªåŠ¨æ£€æµ‹åŒºå—é“¾åœ°å€ç±»å‹
   - æ”¯æŒæ¯”ç‰¹å¸ã€ä»¥å¤ªåŠç­‰å¤šç§åœ°å€æ ¼å¼
   - è§£æé™„åŠ æ•°æ®ä¸­çš„å‰ªè´´æ¿å†…å®¹

4. **æ•°æ®åº“å­˜å‚¨**
   - åˆ›å»ºå®‰å…¨å‘Šè­¦è®°å½•
   - ä¿å­˜å®Œæ•´çš„è¿è§„ä¿¡æ¯
   - ç”Ÿæˆå”¯ä¸€çš„å‘Šè­¦ID

5. **å“åº”æ ¼å¼**
   - æ ‡å‡†åŒ–çš„JSONå“åº”æ ¼å¼
   - åŒ…å«æ“ä½œçŠ¶æ€å’Œè¯¦ç»†ä¿¡æ¯
   - è¿”å›å‘Šè­¦IDå’Œæˆªå›¾URL

## ğŸ› ï¸ åç«¯æ—¥å¿—ç¤ºä¾‹

```
ğŸ“ [POST] /api/security/violations/report-with-screenshot - 127.0.0.1 - curl/8.5.0
[Nest] 3318060  - 08/22/2025, 3:11:30 AM   DEBUG [MinioService] Starting upload 1755803490073-gwbexnpab, concurrent uploads: 1
[Nest] 3318060  - 08/22/2025, 3:11:30 AM   DEBUG [MinioService] File already exists, returning existing URL: /storage/screenshots/65ffa6a7-2f4b-4ab2-b0d6-8db48840e520/alerts/1755755271554-478881c9f4893b836be9bbe05fdd0953.jpg
[Nest] 3318060  - 08/22/2025, 3:11:30 AM   DEBUG [MinioService] Upload finished 1755803490073-gwbexnpab, concurrent uploads: 0
[Nest] 3318060  - 08/22/2025, 3:11:30 AM     LOG [SecurityService] å·²åˆ›å»ºæ–°çš„è¿è§„å‘Šè­¦: 16238ï¼Œæˆªå›¾: /storage/screenshots/65ffa6a7-2f4b-4ab2-b0d6-8db48840e520/alerts/1755755271554-478881c9f4893b836be9bbe05fdd0953.jpg
âœ… [POST] /api/security/violations/report-with-screenshot - 37ms
```

## ğŸ¯ ç»“è®º

### âœ… æµ‹è¯•é€šè¿‡

è¿è§„ä¸ŠæŠ¥æ¥å£æµ‹è¯•**å®Œå…¨æˆåŠŸ**ï¼æ¥å£åŠŸèƒ½å®Œæ•´ï¼Œèƒ½å¤Ÿï¼š

- âœ… æ¥æ”¶å®¢æˆ·ç«¯ä¸Šä¼ çš„è¿è§„æˆªå›¾
- âœ… éªŒè¯å®¢æˆ·ç«¯èº«ä»½
- âœ… è§£æè¿è§„å†…å®¹å’Œç±»å‹
- âœ… è‡ªåŠ¨æ£€æµ‹åŒºå—é“¾åœ°å€ç±»å‹
- âœ… ä¿å­˜æˆªå›¾åˆ°MinIOå­˜å‚¨
- âœ… åˆ›å»ºå®‰å…¨å‘Šè­¦è®°å½•
- âœ… è¿”å›æ ‡å‡†åŒ–å“åº”

### ğŸš€ æ¥å£çŠ¶æ€

æ¥å£å·²ç»å‡†å¤‡å¥½ä¾›å®¢æˆ·ç«¯ä½¿ç”¨ï¼Œå¯ä»¥å¤„ç†å„ç§ç±»å‹çš„è¿è§„äº‹ä»¶ä¸ŠæŠ¥ã€‚

### ğŸ“ æ³¨æ„äº‹é¡¹

1. ç¡®ä¿å®¢æˆ·ç«¯IDåœ¨ç³»ç»Ÿä¸­å·²æ³¨å†Œ
2. ä¸Šä¼ çš„æ–‡ä»¶åº”ä¸ºæœ‰æ•ˆçš„å›¾ç‰‡æ ¼å¼
3. æ—¶é—´æˆ³åº”ä½¿ç”¨ISO 8601æ ¼å¼
4. é™„åŠ æ•°æ®åº”ä¸ºæœ‰æ•ˆçš„JSONå­—ç¬¦ä¸²æ ¼å¼

## ğŸ” å…¶ä»–æµ‹è¯•æ–¹æ³•

### ä½¿ç”¨curlå‘½ä»¤ç›´æ¥æµ‹è¯•

```bash
# åŸºç¡€æµ‹è¯•å‘½ä»¤
curl -X POST "http://localhost:3001/api/security/violations/report-with-screenshot" \
  -F "file=@your_screenshot.jpg" \
  -F "clientId=65ffa6a7-2f4b-4ab2-b0d6-8db48840e520" \
  -F "violationType=BLOCKCHAIN_ADDRESS" \
  -F "violationContent=1BvBMSEYstWetqTFn5Au4m4GFg7xJaNVN2" \
  -F "timestamp=2025-08-22T03:00:00.000Z" \
  -F "additionalData={\"clipboardContent\":\"å‘ç°æ¯”ç‰¹å¸åœ°å€\",\"applicationName\":\"æµ‹è¯•åº”ç”¨\"}"
```

### ä½¿ç”¨Postmanæµ‹è¯•

1. **è®¾ç½®è¯·æ±‚æ–¹å¼**: POST
2. **è®¾ç½®URL**: `http://localhost:3001/api/security/violations/report-with-screenshot`
3. **è®¾ç½®Bodyç±»å‹**: form-data
4. **æ·»åŠ å‚æ•°**:
   - `file`: é€‰æ‹©æ–‡ä»¶ç±»å‹ï¼Œä¸Šä¼ æˆªå›¾
   - `clientId`: textç±»å‹ï¼Œè¾“å…¥å®¢æˆ·ç«¯ID
   - `violationType`: textç±»å‹ï¼Œè¾“å…¥ "BLOCKCHAIN_ADDRESS"
   - `violationContent`: textç±»å‹ï¼Œè¾“å…¥åŒºå—é“¾åœ°å€
   - `timestamp`: textç±»å‹ï¼Œè¾“å…¥æ—¶é—´æˆ³
   - `additionalData`: textç±»å‹ï¼Œè¾“å…¥JSONå­—ç¬¦ä¸²

## ğŸ› å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜1: åç«¯å¯åŠ¨å¤±è´¥

**ç—‡çŠ¶**: TypeScriptç¼–è¯‘é”™è¯¯
```
error TS2339: Property 'alertId' does not exist on type 'CreateSecurityAlertDto'
```

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ `SecurityService` ä¸­çš„ `createSecurityAlert` æ–¹æ³•
2. ç¡®ä¿ä¸å¼•ç”¨DTOä¸­ä¸å­˜åœ¨çš„å±æ€§
3. é‡æ–°å¯åŠ¨å¼€å‘æœåŠ¡

### é—®é¢˜2: æ•°æ®åº“è¿æ¥é”™è¯¯

**ç—‡çŠ¶**:
```
SQLITE_CONSTRAINT: NOT NULL constraint failed: security_screenshots.minio_bucket
```

**è§£å†³æ–¹æ¡ˆ**:
1. ç¡®ä¿ `createSecurityAlert` æ–¹æ³•è®¾ç½®äº†æ‰€æœ‰å¿…éœ€å­—æ®µ
2. æ£€æŸ¥MinIOç›¸å…³å­—æ®µçš„èµ‹å€¼
3. éªŒè¯æ•°æ®åº“è¡¨ç»“æ„

### é—®é¢˜3: æ–‡ä»¶ä¸Šä¼ å¤±è´¥

**ç—‡çŠ¶**: MinIOä¸Šä¼ é”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥MinIOæœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ
2. éªŒè¯å­˜å‚¨æ¡¶ `monitoring-screenshots` æ˜¯å¦å­˜åœ¨
3. æ£€æŸ¥æ–‡ä»¶è·¯å¾„å’Œæƒé™

## ğŸ“š ç›¸å…³æ¥å£æ–‡æ¡£

### APIæ–‡æ¡£åœ°å€
- **Swaggeræ–‡æ¡£**: http://localhost:3001/api/docs
- **å¥åº·æ£€æŸ¥**: http://localhost:3001/health
- **æ•°æ®åº“çŠ¶æ€**: http://localhost:3001/api/system/database/status

### å…¶ä»–å®‰å…¨ç›¸å…³æ¥å£

1. **æˆªå›¾ä¸Šä¼ æ¥å£**: `POST /api/security/screenshots/upload`
2. **å®‰å…¨å‘Šè­¦åˆ—è¡¨**: `GET /api/security/alerts`
3. **å‘Šè­¦è¯¦æƒ…**: `GET /api/security/alerts/:id`
4. **æ›´æ–°å‘Šè­¦çŠ¶æ€**: `PUT /api/security/alerts/:id/status`

## ğŸ”§ å¼€å‘è€…æ³¨æ„äº‹é¡¹

### ä»£ç ä¿®æ”¹è®°å½•

åœ¨æµ‹è¯•è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¿®å¤äº†ä»¥ä¸‹é—®é¢˜ï¼š

1. **ç§»é™¤äº†ä¸å­˜åœ¨çš„ `alertId` å±æ€§å¼•ç”¨**
2. **æ·»åŠ äº† `getAddressType` æ–¹æ³•ç”¨äºæ£€æµ‹åœ°å€ç±»å‹**
3. **å®Œå–„äº† `createSecurityAlert` æ–¹æ³•çš„å­—æ®µè®¾ç½®**

### å…³é”®ä»£ç ç‰‡æ®µ

```typescript
// åŒºå—é“¾åœ°å€ç±»å‹æ£€æµ‹
private getAddressType(address: string): string {
  if (!address) return 'UNKNOWN';

  // æ¯”ç‰¹å¸åœ°å€æ£€æµ‹
  if (address.match(/^[13][a-km-zA-HJ-NP-Z1-9]{25,34}$/)) {
    return 'BITCOIN';
  }
  if (address.match(/^bc1[a-z0-9]{39,59}$/)) {
    return 'BITCOIN_BECH32';
  }

  // ä»¥å¤ªåŠåœ°å€æ£€æµ‹
  if (address.match(/^0x[a-fA-F0-9]{40}$/)) {
    return 'ETHEREUM';
  }

  return 'OTHER';
}
```

---

**æµ‹è¯•æ—¥æœŸ**: 2025-08-22
**æµ‹è¯•ç¯å¢ƒ**: æœ¬åœ°å¼€å‘ç¯å¢ƒ
**åç«¯ç‰ˆæœ¬**: v1.0.0
**æµ‹è¯•çŠ¶æ€**: âœ… é€šè¿‡
**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
