# 屏幕监控系统 - 客户端功能总结

## 概述

屏幕监控系统客户端是一个功能完整的监控解决方案，支持实时屏幕截图、剪贴板监控、区块链地址安全检测和实时通信。系统提供了模拟客户端实现，展示了完整的客户端功能架构。

## 核心功能模块

### 1. 客户端注册与管理

**功能描述：**
- 自动向后端注册客户端信息
- 支持客户端信息配置和管理
- 处理重复注册和错误恢复

**技术实现：**
- HTTP API 调用进行客户端注册
- 支持环境变量配置客户端信息
- 自动生成唯一客户端标识

**配置参数：**
```javascript
{
  CLIENT_NUMBER: 'SIM-{timestamp}',     // 客户端编号
  CLIENT_NAME: '模拟客户端',              // 客户端名称
  COMPUTER_NAME: 'SIMULATOR-PC',        // 计算机名称
  USERNAME: 'simulator',                // 用户名
  IP_ADDRESS: '127.0.0.1',             // IP地址
  MAC_ADDRESS: '00:11:22:33:44:55',    // MAC地址
  OS_VERSION: 'Windows 11 Pro',        // 操作系统版本
  CLIENT_VERSION: '1.0.0',             // 客户端版本
  SCREEN_RESOLUTION: '1920x1080'       // 屏幕分辨率
}
```

### 2. WebSocket 实时通信

**功能描述：**
- 建立与后端的实时双向通信
- 支持房间管理和事件监听
- 自动重连和错误处理

**支持的 WebSocket 事件：**

| 事件名称 | 方向 | 描述 |
|---------|------|------|
| `join-client-room` | 发送 | 加入客户端房间 |
| `room-joined` | 接收 | 房间加入成功确认 |
| `client-heartbeat` | 发送 | 客户端心跳包 |
| `screenshot-request` | 接收 | 服务器请求截图 |
| `screenshot-uploaded` | 发送 | 截图上传完成通知 |
| `whitelist-updated` | 接收 | 白名单更新通知 |
| `request-whitelist` | 发送 | 主动请求白名单 |
| `whitelist-response` | 接收 | 白名单数据响应 |
| `whitelist-error` | 接收 | 白名单请求错误 |

### 3. 屏幕截图采集

**功能描述：**
- 定时自动截图上传
- 支持服务器主动请求截图
- 文件上传和错误重试机制

**技术特性：**
- 支持多种图片格式（JPEG推荐）
- 文件大小和超时控制
- 自动生成唯一文件名
- 上传失败重试机制（最多2次）

**配置参数：**
```javascript
{
  SCREENSHOT_PATH: './1.jpg',           // 截图文件路径
  SCREENSHOT_INTERVAL: 15000,           // 截图间隔（15秒）
  UPLOAD_TIMEOUT: 30000,                // 上传超时时间
  MAX_RETRIES: 2                        // 最大重试次数
}
```

### 4. 剪贴板监控

**功能描述：**
- 模拟剪贴板内容循环检测
- 支持多种内容类型检测
- 与截图上传同步进行

**监控内容类型：**
- 普通文本内容
- 区块链地址（多种类型）
- 敏感信息检测

**模拟剪贴板内容：**
```javascript
[
  'bc1qw508d6qejxtdg4y5r3zarvary0c5xw7kv8f3t4',  // Bitcoin地址
  '0xd8dA6BF26964aF9D7eEd9e03E53415D37aA96045',   // Ethereum地址
  'TRX: TR7NHqjeKQxGTCi8q8ZY4pL8otSzgjLj6t',      // TRON地址
  '普通文本内容，没有区块链地址',                      // 正常内容
  '1A1zP1eP5QGefi2DMPTfTL5SLmv7DivfNa'            // Bitcoin地址
]
```

### 5. 区块链地址安全检测

**功能描述：**
- 实时检测剪贴板中的区块链地址
- 支持多种主流区块链地址格式
- 白名单验证和违规上报

**支持的区块链类型：**

| 区块链 | 地址格式 | 正则表达式 |
|--------|----------|------------|
| Bitcoin | 1xxx, 3xxx, bc1xxx | `/\b[13][a-km-z1-9A-HJ-NP-Z]{25,34}\b\|bc1[a-z0-9]{39,59}/gi` |
| Ethereum | 0xxxx | `/\b0x[a-fA-F0-9]{40}\b/g` |
| TRON | Txxx | `/\bT[A-Za-z1-9]{33}\b/g` |
| Litecoin | Lxxx, Mxxx | `/\b[LM3][a-km-z1-9A-HJ-NP-Z]{26,33}\b/g` |
| Dogecoin | Dxxx | `/\bD{1}[5-9A-HJ-NP-U]{1}[1-9A-HJ-NP-Za-km-z]{32}\b/g` |

**检测流程：**
1. 解析剪贴板内容
2. 使用正则表达式匹配区块链地址
3. 与本地白名单缓存对比
4. 发现违规地址时触发告警
5. 自动上报违规事件

### 6. 白名单管理

**功能描述：**
- 本地白名单缓存管理
- 支持HTTP和WebSocket双重同步
- 实时更新和错误恢复

**同步机制：**

#### HTTP 同步（主要方式）
- 定时从后端API获取最新白名单
- 默认5分钟同步间隔
- 支持增量更新和全量同步

#### WebSocket 同步（备用方式）
- 实时接收白名单更新通知
- 主动请求白名单数据
- HTTP失败时自动切换

**缓存管理：**
```javascript
{
  whitelistAddresses: new Set(),        // 白名单地址集合
  lastWhitelistUpdate: Date,            // 最后更新时间
  WHITELIST_SYNC_INTERVAL: 300000       // 同步间隔（5分钟）
}
```

### 7. 违规事件上报

**功能描述：**
- 自动检测和上报违规行为
- 详细的违规信息记录
- 支持多种违规类型

**上报数据结构：**
```javascript
{
  clientId: 'client-uuid',              // 客户端ID
  violationType: 'BLOCKCHAIN_ADDRESS',  // 违规类型
  violationContent: 'detected-address', // 违规内容
  additionalData: {
    blockchainType: 'BITCOIN',          // 区块链类型
    fullClipboardContent: 'full-text',  // 完整剪贴板内容
    detectionTime: Date,                // 检测时间
    whitelistSize: 100,                 // 白名单大小
    lastWhitelistUpdate: Date           // 白名单更新时间
  }
}
```

### 8. 心跳机制

**功能描述：**
- 定时向服务器发送心跳包
- 维持连接状态和在线检测
- 支持状态监控和异常恢复

**心跳数据：**
```javascript
{
  clientId: 'client-uuid',              // 客户端ID
  status: 'online',                     // 客户端状态
  ip: '127.0.0.1',                     // IP地址
  timestamp: Date                       // 时间戳
}
```

**配置参数：**
```javascript
{
  HEARTBEAT_INTERVAL: 30000             // 心跳间隔（30秒）
}
```

## 高级功能

### 1. 并发多客户端支持

**功能描述：**
- 支持同时运行多个模拟客户端
- 错峰启动减少服务器压力
- 独立配置和状态管理

**使用方式：**
```bash
# 启动20个并发客户端
CLIENT_COUNT=20 node simulate-client.js

# 自定义错峰间隔
CLIENT_COUNT=10 CLIENT_STAGGER_MS=500 node simulate-client.js
```

### 2. 环境变量配置

**支持的环境变量：**
```bash
# 服务器配置
API_BASE_URL=http://localhost:3001/api
WS_URL=http://localhost:3005/monitor

# 客户端信息
CLIENT_NUMBER=SIM-001
CLIENT_NAME=测试客户端
COMPUTER_NAME=TEST-PC
USERNAME=testuser
IP_ADDRESS=192.168.1.100

# 时间间隔配置
HEARTBEAT_INTERVAL=30000
SCREENSHOT_INTERVAL=15000
WHITELIST_SYNC_INTERVAL=300000

# 并发配置
CLIENT_COUNT=20
CLIENT_STAGGER_MS=200

# 自定义剪贴板内容
CLIPBOARD_CONTENTS='["address1", "address2"]'
```

### 3. 错误处理和恢复

**网络错误处理：**
- HTTP请求超时和重试
- WebSocket断线自动重连
- 文件上传失败重试机制

**数据同步错误处理：**
- 白名单同步失败时切换到WebSocket
- 本地缓存保护机制
- 错误日志记录和监控

**资源管理：**
- 定时器清理和内存释放
- 文件句柄管理
- 优雅关闭和信号处理

## 部署和运行

### 1. 依赖安装

```bash
npm install socket.io-client axios form-data uuid
```

### 2. 单客户端运行

```bash
# 基本运行
node simulate-client.js

# 自定义配置运行
API_BASE_URL=http://server:3001/api \
CLIENT_NAME=生产客户端 \
node simulate-client.js
```

### 3. 多客户端并发运行

```bash
# 启动20个并发客户端
CLIENT_COUNT=20 node simulate-client.js

# 压力测试（100个客户端）
CLIENT_COUNT=100 CLIENT_STAGGER_MS=100 node simulate-client.js
```

### 4. 生产环境部署

```bash
# 使用PM2管理进程
pm2 start simulate-client.js --name "monitor-client" \
  --env API_BASE_URL=https://api.company.com \
  --env CLIENT_NAME=生产客户端

# Docker容器运行
docker run -e API_BASE_URL=http://backend:3001/api \
  -e CLIENT_COUNT=5 \
  monitor-client:latest
```

## 监控和日志

### 1. 运行状态监控

**控制台输出示例：**
```
🤖 模拟客户端初始化
📋 客户端编号: SIM-1703123456789
🚀 启动模拟客户端...
📝 注册客户端到数据库...
✅ 客户端注册成功: 客户端创建成功
📋 客户端ID: uuid-string
🔌 连接WebSocket: http://localhost:3005/monitor
✅ WebSocket连接成功: socket-id
🏠 加入房间成功: client-uuid
📡 通过WebSocket请求白名单...
📋 收到白名单响应: 10 个地址
💾 本地白名单缓存已更新: 10 个地址
❤️ 开始心跳 (间隔: 30000ms)
📸 开始截图上传 (间隔: 15000ms)
🔄 开始白名单同步 (间隔: 300000ms)
✅ 模拟客户端启动成功！
```

### 2. 错误日志

**常见错误类型：**
- 网络连接错误
- 文件上传失败
- 白名单同步错误
- WebSocket连接断开

### 3. 性能指标

**关键指标：**
- 心跳成功率
- 截图上传成功率
- 白名单同步延迟
- 违规检测响应时间
- 内存使用情况

## 安全特性

### 1. 数据安全
- 敏感信息加密传输
- 本地缓存数据保护
- 安全的API认证机制

### 2. 隐私保护
- 最小化数据收集
- 用户隐私信息脱敏
- 符合数据保护法规

### 3. 系统安全
- 防止恶意代码注入
- 安全的文件上传机制
- 网络通信加密

## 扩展性设计

### 1. 模块化架构
- 功能模块独立设计
- 支持插件式扩展
- 配置驱动的功能开关

### 2. 协议扩展
- 支持新的WebSocket事件
- 可扩展的违规检测规则
- 灵活的数据格式定义

### 3. 平台适配
- 跨平台兼容性设计
- 多种部署方式支持
- 云原生架构适配

## 总结

屏幕监控系统客户端提供了完整的监控解决方案，具备以下核心优势：

1. **功能完整**：涵盖截图、监控、检测、通信等全部功能
2. **实时性强**：WebSocket实时通信，毫秒级响应
3. **可靠性高**：多重错误处理和自动恢复机制
4. **扩展性好**：模块化设计，支持灵活配置和扩展
5. **易于部署**：支持多种部署方式和环境配置
6. **监控全面**：详细的日志记录和性能监控

该客户端实现为企业级监控系统提供了坚实的技术基础，可以满足各种复杂的业务需求和安全要求。